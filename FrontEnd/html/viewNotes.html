<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Markdown Viewer</title>

  <!-- GitHub Markdown CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown.min.css">
  <!-- Google Sans Font -->
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500&display=swap" rel="stylesheet">
  <!-- Marked.js -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>


  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      font-family: "Google Sans", Roboto, Arial, sans-serif;
      background-color: #ffffff;
      color: #24292f;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 24px;
      background-color: #dbe9f4;
      color: #202124;
      border-bottom: 1px solid #cadbe8;
      box-shadow: 0 1px 2px rgba(60, 64, 67, 0.1);
    }

    header h1 {
      font-size: 1.4rem;
      font-weight: 500;
      color: #202124;
    }

    .button-group {
      display: flex;
      gap: 10px;
    }

    .button-group button {
      background-color: #4386c9;
      border: none;
      border-radius: 20px;
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease;
      box-shadow: 0 1px 2px rgba(60, 64, 67, 0.15);
    }

    .button-group button:hover {
      background-color: #1a3d68;
    }

    .button-group svg {
      width: 20px;
      height: 20px;
      fill: #ffffff;
    }

    .container {
      height: calc(100vh - 65px);
      width: 100%;
      background-color: #f7f8f8;
      overflow-y: auto;
    }

    .markdown-body {
      background-color: #f7f8f8;
      color: #24292f;
      font-family: inherit;
      font-size: 1rem;
      line-height: 1.6;
      padding: 20px;
      box-sizing: border-box;
      width: 100%;
    }

    .markdown-body table{
      background-color: inherit;
      border: none;
      padding: 8px;
      border-collapse: collapse;
    }

    .markdown-body hr {
      border: none;
      border-top: .5px solid #26292c;
      margin: 16px 0;
      height: 0;
    }

.markdown-body th,
.markdown-body td {
  background-color: #f7f8f8;
  border: none;
}

.trash{
    fill: #ffffff;
}

    @media (max-width: 768px) {
      .button-group button svg {
        fill: #202124;
      }
    }
  </style>
</head>

<body>

  <header>
    <h1 id="noteTitle">Loading...</h1>
    <div class="button-group">
      <button id="editBtn" title="Edit">
        <!-- Pencil Icon -->
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M13.17 3.6c.69-.39 1.51-.49 2.28-.28.34.09.63.23.9.41.26.17.56.4.91.67.34.27.64.51.88.71.25.22.48.45.66.77.39.69.49 1.51.28 2.28-.1.34-.23.63-.41.9-.17.26-.4.56-.67.91L10.9 19.15c-.02.03-.04.05-.06.07-.34.43-.59.76-.87 1.01-.26.22-.56.41-.88.56-.37.18-.77.28-1.3.41l-2.13.52c-.15.04-.33.08-.48.1-.17.03-.42.05-.71-.05-.34-.1-.63-.33-.81-.64-.16-.25-.2-.5-.21-.67 0-.15 0-.32 0-.47L3.35 17.83c0-.03 0-.06 0-.09-.01-.54-.01-.95.07-1.35.07-.34.18-.67.32-.97.18-.37.43-.7.77-1.14l7.1-9.1c.27-.35.5-.63.71-.85.22-.25.45-.47.77-.66zM12 21c0-.55.45-1 1-1h7c.55 0 1 .45 1 1s-.45 1-1 1h-7c-.55 0-1-.45-1-1z"
            fill="#fff" />
        </svg>
      </button>

      <button id="deleteBtn" title="Delete">
        <!-- Trash Icon -->
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path class="trash"
            d="M12 2.75c-.98 0-1.81.63-2.12 1.5-.14.39-.58.6-.97.46-.39-.14-.6-.58-.46-.97C9.4 2.3 10.66 1.25 12 1.25s2.6 1.05 3.05 2.49c.14.39-.07.83-.46.97s-.83-.07-.97-.46c-.31-.87-1.14-1.5-2.12-1.5z" />
          <path class="trash" d="M2.75 6c0-.41.34-.75.75-.75h17.001a.75.75 0 110 1.5H3.5A.75.75 0 012.75 6z" />
          <path class="trash"
            d="M5.92 8.45a.75.75 0 00-1.5.1l.46 7.05c.08 1.29.15 2.28.33 3.12.18.85.47 1.53 1.06 2.08.6.56 1.32.79 2.18.9.82.1 1.87.1 3.15.1h.88c1.28 0 2.33 0 3.15-.1.86-.1 1.58-.34 2.18-.9.59-.55.88-1.23 1.06-2.08.18-.84.25-1.83.33-3.12l.46-7.05a.75.75 0 10-1.5-.1l-.46 6.9c-.09 1.35-.15 2.28-.3 2.96-.13.65-.3 1.02-.55 1.25-.25.23-.6.38-1.29.46-.7.08-1.64.08-2.98.08h-.77c-1.34 0-2.28 0-2.98-.08-.7-.08-1.04-.23-1.29-.46-.25-.23-.42-.6-.55-1.25-.15-.68-.21-1.61-.3-2.96l-.46-6.9z" />
          <path class="trash"
            d="M9.43 10.25a.75.75 0 01.82.67l.5 5a.75.75 0 11-1.49.16l-.5-5a.75.75 0 01.67-.83zM15.25 11.07a.75.75 0 00-1.5.17l-.5 5a.75.75 0 001.5.16l.5-5z" />
        </svg>
      </button>
    </div>
  </header>

  <div class="container">
    <article id="preview" class="markdown-body"></article>
  </div>

<script>
  const preview = document.getElementById("preview");
  const noteTitle = document.getElementById("noteTitle");

  function updatePreview(content) {
    preview.innerHTML = marked.parse(content || "*No content*");
  }

  function getNoteIdFromURL() {
    const params = new URLSearchParams(window.location.search);
    return params.get("id");
  }

  function getDirectoryPath() {
    // Remove the last segment ($view) from the path
    const path = window.location.pathname; // e.g., /tree/morning/$view
    const parts = path.split('/');
    if(parts.length > 1) {
      parts.pop(); // remove last segment ($view)
      return parts.join('/') + '/'; // e.g., /tree/morning/
    }
    return '/';
  }

  async function loadNote() {
    const noteId = getNoteIdFromURL();
    if (!noteId) {
      noteTitle.textContent = "Invalid URL - No ID";
      updatePreview("");
      return;
    }

    try {
      const res = await fetch(`/tree/note?id=${noteId}`);
      const data = await res.json();

      if (res.ok) {
        noteTitle.textContent = data.name || "Untitled";
        updatePreview(data.content || "");
      } else {
        noteTitle.textContent = "Note not found";
        updatePreview(data.error || "No content.");
      }
    } catch (err) {
      console.error("Error loading note:", err);
      noteTitle.textContent = "Error";
      updatePreview("Failed to load note.");
    }
  }

  // Delete button behavior (waits for backend confirmation)
  document.getElementById("deleteBtn").addEventListener("click", async () => {
    const id = getNoteIdFromURL();

    try {
      const res = await fetch("/tree/delete", {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: parseInt(id) })
      });

      if (res.ok) {
        // Redirect to directory path after delete
        window.location.href = getDirectoryPath();
      } else {
        console.error("Delete failed");
      }
    } catch (err) {
      console.error("Error deleting note:", err);
    }
  });

  // Edit button behavior
  document.getElementById("editBtn").addEventListener("click", () => {
    const id = getNoteIdFromURL();
    window.location.href = `/editNotes.html?id=${id}`;
  });

  loadNote();
</script>

</body>

</html>
