<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Markdown Directory</title>
  <style>
    body { font-family: sans-serif; }
    ul { list-style-type: none; padding-left: 1rem; }
    .folder { font-weight: bold; color: darkblue; cursor: pointer; }
    .file { color: darkgreen; cursor: pointer; }
    .delete-btn {
      color: red;
      margin-left: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    button {
      margin: 4px;
      padding: 6px 10px;
      border: none;
      background-color: #4CAF50;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background-color: #388E3C; }
    #address-bar {
      font-style: italic;
      color: #555;
      margin: 0.5rem 0 1rem 0;
    }
  </style>
</head>
<body>
  <h2>Markdown Directory</h2>
  <div>
    <button onclick="addNote()">Add Notes</button>
    <button onclick="addFolder()">Add Folder</button>
    <button onclick="goBack()">Back</button>
  </div>
  <div id="address-bar">Address: <span id="current-path">/tree/</span></div>
  <hr>
  <div id="tree-container"></div>

  <script>
    let currentFolderId = 1;
    let currentPath = ["tree"];
    const historyStack = [];

    function updateAddressBar() {
      const pathStr = "/" + currentPath.join("/");
      window.history.pushState({}, "", pathStr);
      document.getElementById("current-path").textContent = pathStr;
    }

    async function renderTree(folderId = 1) {
      try {
        const res = await fetch(`/tree?id=${folderId}`);
        const result = await res.json();

        if (result.error) {
          document.getElementById("tree-container").innerHTML = `<p>${result.error}</p>`;
          return;
        }

        const node = result.node;
        const children = result.children;

        if (node.is_file) {
          // Files shouldn't be rendered here anymore
          return;
        }

        let html = "<ul>";
        if (children.length === 0) {
          html += "<li>(Empty folder)</li>";
        } else {
          for (const child of children) {
            if (child.is_file) {
              html += `
                <li class="file">
                  <span onclick="viewFile(${child.id}, '${child.name}')">${child.name}</span>
                  <span class="delete-btn" onclick="deleteNode(${child.id})">✖</span>
                </li>`;
            } else {
              html += `
                <li class="folder">
                  <span onclick="enterFolder(${child.id}, '${child.name}')">${child.name}</span>
                  <span class="delete-btn" onclick="deleteNode(${child.id})">✖</span>
                </li>`;
            }
          }
        }
        html += "</ul>";
        document.getElementById("tree-container").innerHTML = html;
        updateAddressBar();

      } catch (err) {
        console.error("Error loading tree:", err);
      }
    }

    async function enterFolder(folderId, folderName) {
      historyStack.push({ id: currentFolderId, path: [...currentPath] });
      currentFolderId = folderId;
      currentPath.push(folderName);
      await renderTree(currentFolderId);
    }

    async function goBack() {
      if (historyStack.length > 0) {
        const last = historyStack.pop();
        currentFolderId = last.id;
        currentPath = last.path;
        await renderTree(currentFolderId);
      }
    }

    function viewFile(fileId, fileName) {
      const encodedSegments = currentPath.slice(1).map(encodeURIComponent);
      const encodedPath = encodedSegments.join("/");
      const url = `/tree/${encodedPath}/$view?id=${fileId}`;
      window.location.href = url;
    }


    function addNote() {
      const encodedSegments = currentPath.slice(1).map(encodeURIComponent);
      const encodedPath = encodedSegments.join("/");
      const url = `/tree/${encodedPath}/Add%20Notes?parent_id=${currentFolderId}`;
      window.location.href = url;
    }

    async function addFolder() {
      const name = prompt("Enter folder name:");
      if (!name) return;
      const body = {
        name,
        is_file: false,
        parent_id: currentFolderId
      };
      await fetch("/tree/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      await renderTree(currentFolderId);
    }

    async function deleteNode(id) {
      if (!confirm("Are you sure you want to delete this item?")) return;
      await fetch(`/tree/delete`, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id })
      });
      await renderTree(currentFolderId);
    }

    window.onload = async () => {
      const pathSegments = decodeURI(window.location.pathname).split("/").filter(Boolean);
      if (pathSegments[0] !== "tree") {
        currentFolderId = 1;
        currentPath = ["tree"];
        await renderTree(currentFolderId);
        return;
      }

      currentFolderId = 1;
      currentPath = ["tree"];
      let folderId = 1;

      for (let i = 1; i < pathSegments.length; i++) {
        const segment = pathSegments[i];
        if (segment === "Add Notes" || segment === "$view") break;

        const res = await fetch(`/tree?id=${folderId}`);
        const result = await res.json();
        const children = result.children;

        const nextNode = children.find(child => child.name === segment);
        if (!nextNode) {
          alert(`Path segment "${segment}" not found.`);
          break;
        }

        currentPath.push(segment);

        if (nextNode.is_file) {
          viewFile(nextNode.id, nextNode.name);
          return;
        } else {
          folderId = nextNode.id;
        }
      }

      currentFolderId = folderId;
      await renderTree(currentFolderId);
    };
  </script>
</body>
</html>
